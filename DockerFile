FROM php:8.5-apache

ARG GITHUB_TOKEN
WORKDIR /var/www

ENV DEBIAN_FRONTEND=noninteractive

# =========================
# System dependencies
# =========================
RUN apt-get update \
 && apt-get install -y \
    git \
    zip \
    unzip \
    cron \
    supervisor \
    libzip-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libldap2-dev \
    ca-certificates \
    curl \
    gnupg \
 && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# =========================
# PHP extensions
# =========================
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
 && docker-php-ext-install \
    mysqli \
    pdo_mysql \
    bcmath \
    mbstring \
    zip \
    gd \
    ldap \
    pcntl \
    sockets

# =========================
# PECL extensions
# =========================
RUN pecl install redis xdebug \
 && docker-php-ext-enable redis xdebug

# =========================
# Apache
# =========================
RUN a2enmod rewrite

# =========================
# Composer
# =========================
COPY composer.json composer.lock /var/www/

RUN curl -sS https://getcomposer.org/installer | php \
 && php composer.phar install --no-interaction --prefer-dist

# =========================
# App
# =========================
COPY . /var/www

# =========================
# Cron
# =========================
COPY docker/cron/root /etc/cron.d/laravel
RUN chmod 0644 /etc/cron.d/laravel \
 && crontab /etc/cron.d/laravel

EXPOSE 80 6001 6004

CMD ["apache2-foreground"]
