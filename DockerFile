# =========================
# Base image
# =========================
FROM php:8.5-apache

# =========================
# Arguments
# =========================
ARG GITHUB_TOKEN
WORKDIR /var/www

# =========================
# System dependencies
# =========================
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    git \
    zip \
    unzip \
    cron \
    supervisor \
    libzip-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libldap2-dev \
    libonig-dev \
    libevent-dev \
    unixodbc-dev \
    ca-certificates \
    curl \
    gnupg \
    wget \
    locales \
 && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# =========================
# PHP extensions (core)
# =========================
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
 && docker-php-ext-install \
    mysqli \
    pdo_mysql \
    bcmath \
    mbstring \
    zip \
    gd \
    ldap \
    pcntl \
    sockets

# =========================
# PECL extensions
# =========================
RUN pecl install xdebug redis \
 && docker-php-ext-enable xdebug redis

# =========================
# Apache
# =========================
RUN echo "ServerName localhost" > /etc/apache2/domain.conf \
 && a2enmod rewrite

# =========================
# Oracle Instant Client
# =========================
COPY docker/oracle/ /tmp/oracle/
RUN mkdir -p /opt/oracle \
 && unzip /tmp/oracle/instantclient-basic-linux.x64-12.1.0.2.0.zip -d /opt/oracle \
 && unzip /tmp/oracle/instantclient-sdk-linux.x64-12.1.0.2.0.zip -d /opt/oracle \
 && ln -s /opt/oracle/instantclient_12_1/libclntsh.so.12.1 /opt/oracle/instantclient_12_1/libclntsh.so \
 && ln -s /opt/oracle/instantclient_12_1/libocci.so.12.1 /opt/oracle/instantclient_12_1/libocci.so \
 && echo /opt/oracle/instantclient_12_1 > /etc/ld.so.conf.d/oracle-instantclient.conf \
 && ldconfig \
 && echo 'instantclient,/opt/oracle/instantclient_12_1/' | pecl install oci8 \
 && docker-php-ext-enable oci8 \
 && docker-php-ext-configure pdo_oci --with-pdo-oci=instantclient,/opt/oracle/instantclient_12_1,12.1 \
 && docker-php-ext-install pdo_oci \
 && docker-php-ext-enable pdo_oci \
 && rm -rf /tmp/oracle

# =========================
# SQL Server
# =========================
RUN curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add - \
 && curl https://packages.microsoft.com/config/debian/10/prod.list > /etc/apt/sources.list.d/mssql-release.list \
 && apt-get update \
 && ACCEPT_EULA=Y apt-get install -y msodbcsql17 \
 && pecl install sqlsrv-5.9.0 pdo_sqlsrv-5.9.0 \
 && docker-php-ext-enable sqlsrv pdo_sqlsrv

# =========================
# NodeJS & Composer
# =========================
RUN apt-get update && apt-get install -y nodejs npm \
 && curl -sS https://getcomposer.org/installer | php \
 && mv composer.phar /usr/local/bin/composer \
 && composer config -g github-oauth.github.com $GITHUB_TOKEN

# =========================
# Copy app
# =========================
COPY . /var/www
RUN chmod -R 777 /var/www

# =========================
# Cron
# =========================
COPY docker/cron/root /etc/cron.d/laravel
RUN chmod 0644 /etc/cron.d/laravel \
 && crontab /etc/cron.d/laravel \
 && touch /var/log/cron.log

# =========================
# Ports
# =========================
EXPOSE 80 6001 6004

# =========================
# Start Apache + Cron
# =========================
CMD service cron start && apache2-foreground
