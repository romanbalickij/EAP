# =========================
# Base image
# =========================
FROM php:8.5-apache

# =========================
# Arguments
# =========================
ARG GITHUB_TOKEN
WORKDIR /var/www

# =========================
# Environment
# =========================
ENV DEBIAN_FRONTEND=noninteractive

# =========================
# System dependencies
# =========================
RUN apt-get update \
 && apt-get install -y \
    git zip unzip cron supervisor \
    libzip-dev libpng-dev libjpeg-dev libfreetype6-dev \
    libldap2-dev \
    ca-certificates curl gnupg \
 && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# =========================
# PHP extensions (core)
# =========================
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
 && docker-php-ext-install \
    mysqli \
    pdo_mysql \
    bcmath \
    mbstring \
    zip \
    gd \
    ldap \
    pcntl \
    sockets

# =========================
# PECL extensions
# =========================
RUN pecl install redis xdebug \
 && docker-php-ext-enable redis xdebug

# =========================
# Apache modules
# =========================
RUN a2enmod rewrite

# =========================
# Copy composer files first (for caching)
# =========================
COPY composer.json composer.lock /var/www/

# =========================
# Composer
# =========================
RUN curl -sS https://getcomposer.org/installer | php \
 && php composer.phar config -g github-oauth.github.com "$GITHUB_TOKEN" \
 && php composer.phar install --no-interaction --prefer-dist

# =========================
# Copy application
# =========================
COPY . /var/www

# =========================
# Cron
# =========================
COPY docker/cron/root /etc/cron.d/laravel
RUN chmod 0644 /etc/cron.d/laravel \
 && crontab /etc/cron.d/laravel

# =========================
# Ports
# =========================
EXPOSE 80 6001 6004

# =========================
# Entrypoint
# =========================
COPY docker/run.sh /var/www/docker/run.sh
RUN chmod +x /var/www/docker/run.sh

ENTRYPOINT ["/var/www/docker/run.sh"]
